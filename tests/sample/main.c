/*
 * Copyright (c) 2025 tinyVision.ai Inc.
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#include <stdint.h>

#include <mpix/image.h>
#include <mpix/utils.h>
#include <mpix/test.h>

#define WIDTH  5
#define HEIGHT 16

static const uint8_t buf[WIDTH * HEIGHT * 3] = {
	/* Row 0 */
	0x00, 0x00, 0x00, 0x10, 0x10, 0x10, 0x20, 0x20, 0x20, 0x30, 0x30, 0x30, 0x40, 0x40, 0x40, //
	/* Row 1 */
	0x00, 0x00, 0x00, 0x10, 0x10, 0x10, 0x20, 0x20, 0x20, 0x30, 0x30, 0x30, 0x40, 0x40, 0x40, //
	/* Row 2 */
	0x00, 0x00, 0x00, 0x10, 0x10, 0x10, 0x20, 0x20, 0x20, 0x30, 0x30, 0x30, 0x40, 0x40, 0x40, //
	/* Row 3 */
	0x00, 0x00, 0x00, 0x10, 0x10, 0x10, 0x20, 0x20, 0x20, 0x30, 0x30, 0x30, 0x40, 0x40, 0x40, //
	/* Row 4 */
	0x00, 0x00, 0x00, 0x10, 0x10, 0x10, 0x20, 0x20, 0x20, 0x30, 0x30, 0x30, 0x40, 0x40, 0x40, //
	/* Row 5 */
	0x00, 0x00, 0x00, 0x10, 0x10, 0x10, 0x20, 0x20, 0x20, 0x30, 0x30, 0x30, 0x40, 0x40, 0x40, //
	/* Row 6 */
	0x00, 0x00, 0x00, 0x10, 0x10, 0x10, 0x20, 0x20, 0x20, 0x30, 0x30, 0x30, 0x40, 0x40, 0x40, //
	/* Row 7 */
	0x00, 0x00, 0x00, 0x10, 0x10, 0x10, 0x20, 0x20, 0x20, 0x30, 0x30, 0x30, 0x40, 0x40, 0x40, //
	/* Row 8 */
	0x0f, 0x0f, 0x0f, 0x1f, 0x1f, 0x1f, 0x2f, 0x2f, 0x2f, 0x3f, 0x3f, 0x3f, 0x4f, 0x4f, 0x4f, //
	/* Row 9 */
	0x0f, 0x0f, 0x0f, 0x1f, 0x1f, 0x1f, 0x2f, 0x2f, 0x2f, 0x3f, 0x3f, 0x3f, 0x4f, 0x4f, 0x4f, //
	/* Row 10 */
	0x0f, 0x0f, 0x0f, 0x1f, 0x1f, 0x1f, 0x2f, 0x2f, 0x2f, 0x3f, 0x3f, 0x3f, 0x4f, 0x4f, 0x4f, //
	/* Row 11 */
	0x0f, 0x0f, 0x0f, 0x1f, 0x1f, 0x1f, 0x2f, 0x2f, 0x2f, 0x3f, 0x3f, 0x3f, 0x4f, 0x4f, 0x4f, //
	/* Row 12 */
	0x0f, 0x0f, 0x0f, 0x1f, 0x1f, 0x1f, 0x2f, 0x2f, 0x2f, 0x3f, 0x3f, 0x3f, 0x4f, 0x4f, 0x4f, //
	/* Row 13 */
	0x0f, 0x0f, 0x0f, 0x1f, 0x1f, 0x1f, 0x2f, 0x2f, 0x2f, 0x3f, 0x3f, 0x3f, 0x4f, 0x4f, 0x4f, //
	/* Row 14 */
	0x0f, 0x0f, 0x0f, 0x1f, 0x1f, 0x1f, 0x2f, 0x2f, 0x2f, 0x3f, 0x3f, 0x3f, 0x4f, 0x4f, 0x4f, //
	/* Row 15 */
	0x0f, 0x0f, 0x0f, 0x1f, 0x1f, 0x1f, 0x2f, 0x2f, 0x2f, 0x3f, 0x3f, 0x3f, 0x4f, 0x4f, 0x4f, //
};

int main(void)
{
	struct mpix_image img = {};
	uint16_t col_tally[5];
	uint16_t row_tally[2];

	mpix_image_from_buf(&img, buf, sizeof(buf), WIDTH, HEIGHT, MPIX_FMT_RGB24);

	for (int i = 0; i < 1000; i++) {
		uint8_t rgb_value[3];

		mpix_image_sample_random_rgb(&img, rgb_value);

		mpix_test_equal(rgb_value[0], rgb_value[1]);
		mpix_test_equal(rgb_value[1], rgb_value[2]);
		mpix_test(rgb_value[0] >> 4 <= 0x4);
		mpix_test((rgb_value[0] & 0x0f) == 0x0 || (rgb_value[0] & 0x0f) == 0xf);

		row_tally[rgb_value[0] & 0x1]++;
		col_tally[rgb_value[0] >> 4]++;
	}

	mpix_test(row_tally[0] > 0);
	mpix_test(row_tally[1] > 0);

	mpix_test(col_tally[0] > 0);
	mpix_test(col_tally[1] > 0);
	mpix_test(col_tally[2] > 0);
	mpix_test(col_tally[3] > 0);

	mpix_image_free(&img);

	mpix_test_ok(img.err);

	return 0;
}
